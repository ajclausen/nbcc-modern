---
import { siteConfig } from '@/data/siteConfig';
import { mainNavigation, getActiveNavItem } from '@/data/navigation';
import Icon from '@/components/ui/Icon.astro';

const currentPath = getActiveNavItem(Astro.url.pathname);

// Check if current path is within a nav item's children
const isChildActive = (item: typeof mainNavigation[0]) => {
  if (!item.children) return false;
  return item.children.some(child => currentPath === child.href || currentPath.startsWith(child.href + '/'));
};
---

<header class="fixed top-0 left-0 right-0 z-50 transition-all duration-300" id="main-header">
  <div class="header-bg">
    <div class="container-default">
      <nav class="flex items-center justify-between h-16 lg:h-20" aria-label="Main navigation">
        <!-- Logo -->
        <a href="/" class="flex items-center gap-3 group">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary-600 to-primary-800 flex items-center justify-center shadow-sm group-hover:shadow-md transition-shadow">
            <span class="text-white font-display text-xl font-bold">N</span>
          </div>
          <div class="hidden sm:block">
            <span class="block text-primary-900 font-display text-lg font-semibold leading-tight">New Brunswick</span>
            <span class="block text-stone-500 text-xs tracking-wide">Church of Christ</span>
          </div>
        </a>

        <!-- Desktop Navigation -->
        <div class="hidden lg:flex items-center gap-1">
          {mainNavigation.map((item) => (
            item.highlight ? (
              <a
                href={item.href}
                class="ml-3 btn btn-primary !py-2.5 !px-5 !text-sm"
              >
                {item.label}
              </a>
            ) : item.children ? (
              <!-- Dropdown Nav Item -->
              <div class="relative group">
                <a
                  href={item.href}
                  class:list={[
                    'px-4 py-2 text-sm font-medium transition-colors relative inline-flex items-center gap-1',
                    currentPath === item.href || isChildActive(item)
                      ? 'text-primary-700'
                      : 'text-stone-600 hover:text-primary-700',
                  ]}
                  aria-current={currentPath === item.href ? 'page' : undefined}
                >
                  {item.label}
                  <svg class="w-3.5 h-3.5 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                  </svg>
                  {(currentPath === item.href || isChildActive(item)) && (
                    <span class="absolute bottom-0 left-4 right-4 h-0.5 bg-terra-400 rounded-full"></span>
                  )}
                </a>

                <!-- Dropdown Menu -->
                <div class="dropdown-menu absolute top-full left-0 pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                  <div class="bg-cream-50 rounded-xl shadow-card border border-cream-200 py-2 min-w-[200px] overflow-hidden">
                    {item.children.map((child) => (
                      <a
                        href={child.href}
                        class:list={[
                          'block px-4 py-2.5 text-sm font-medium transition-colors',
                          currentPath === child.href
                            ? 'text-primary-700 bg-primary-50'
                            : 'text-stone-600 hover:text-primary-700 hover:bg-cream-100',
                        ]}
                        aria-current={currentPath === child.href ? 'page' : undefined}
                      >
                        {child.label}
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            ) : (
              <a
                href={item.href}
                class:list={[
                  'px-4 py-2 text-sm font-medium transition-colors relative',
                  currentPath === item.href
                    ? 'text-primary-700'
                    : 'text-stone-600 hover:text-primary-700',
                ]}
                aria-current={currentPath === item.href ? 'page' : undefined}
              >
                {item.label}
                {currentPath === item.href && (
                  <span class="absolute bottom-0 left-4 right-4 h-0.5 bg-terra-400 rounded-full"></span>
                )}
              </a>
            )
          ))}
        </div>

        <!-- Mobile Menu Button -->
        <button
          type="button"
          class="lg:hidden w-10 h-10 flex items-center justify-center text-stone-700 hover:text-primary-700 hover:bg-stone-100 rounded-xl transition-colors"
          id="mobile-menu-button"
          aria-expanded="false"
          aria-controls="mobile-menu"
          aria-label="Toggle menu"
        >
          <Icon name="menu" size="lg" class="menu-icon" />
          <Icon name="x" size="lg" class="close-icon hidden" />
        </button>
      </nav>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="lg:hidden fixed inset-x-0 top-16 bottom-0 bg-cream-50/98 backdrop-blur-md transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto"
    aria-hidden="true"
  >
    <div class="container-default py-8">
      <div class="flex flex-col gap-1">
        {mainNavigation.map((item) => (
          item.children ? (
            <!-- Mobile Dropdown -->
            <div class="mobile-dropdown">
              <button
                type="button"
                class:list={[
                  'w-full flex items-center justify-between px-4 py-3.5 text-lg font-medium rounded-xl transition-all mobile-dropdown-trigger',
                  currentPath === item.href || isChildActive(item)
                    ? 'text-primary-700 bg-primary-100'
                    : 'text-stone-700 hover:text-primary-700 hover:bg-stone-100',
                ]}
                aria-expanded="false"
              >
                <span>{item.label}</span>
                <svg class="w-5 h-5 transition-transform mobile-dropdown-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </button>

              <div class="mobile-dropdown-content hidden pl-4 mt-1 space-y-1">
                {item.children.map((child) => (
                  <a
                    href={child.href}
                    class:list={[
                      'block px-4 py-2.5 text-base font-medium rounded-lg transition-colors',
                      currentPath === child.href
                        ? 'text-primary-700 bg-primary-50'
                        : 'text-stone-600 hover:text-primary-700 hover:bg-stone-100',
                    ]}
                    aria-current={currentPath === child.href ? 'page' : undefined}
                  >
                    {child.label}
                  </a>
                ))}
              </div>
            </div>
          ) : (
            <a
              href={item.href}
              class:list={[
                'px-4 py-3.5 text-lg font-medium rounded-xl transition-all',
                currentPath === item.href
                  ? 'text-primary-700 bg-primary-100'
                  : 'text-stone-700 hover:text-primary-700 hover:bg-stone-100',
                item.highlight && 'bg-terra-500 text-white hover:bg-terra-600 hover:text-white mt-4',
              ]}
              aria-current={currentPath === item.href ? 'page' : undefined}
            >
              {item.label}
            </a>
          )
        ))}
      </div>

      <!-- Contact Info in Mobile Menu -->
      <div class="mt-10 pt-8 border-t border-stone-200">
        <p class="text-sm font-medium text-stone-500 uppercase tracking-wider mb-4">Contact Us</p>
        <div class="space-y-4">
          <a href={`tel:${siteConfig.contact.phone}`} class="flex items-center gap-3 text-stone-600 hover:text-primary-700 transition-colors">
            <Icon name="phone" />
            <span>{siteConfig.contact.phoneFormatted}</span>
          </a>
          <a href={`mailto:${siteConfig.contact.email}`} class="flex items-center gap-3 text-stone-600 hover:text-primary-700 transition-colors">
            <Icon name="email" />
            <span>{siteConfig.contact.email}</span>
          </a>
          <a href={siteConfig.contact.mapUrl} target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 text-stone-600 hover:text-primary-700 transition-colors">
            <Icon name="map" />
            <span>Get Directions</span>
          </a>
        </div>
      </div>

      <!-- Service Times Quick View -->
      <div class="mt-8 p-5 bg-primary-900 rounded-2xl text-white">
        <p class="font-display font-semibold mb-3">Join Us Sunday</p>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-primary-200">Sunday School</span>
            <span class="font-semibold">9:00 AM</span>
          </div>
          <div class="flex justify-between">
            <span class="text-primary-200">Worship Service</span>
            <span class="font-semibold">10:00 AM</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Spacer for fixed header -->
<div class="h-16 lg:h-20"></div>

<style>
  .header-bg {
    background: rgba(254, 253, 251, 0.92);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(212, 206, 195, 0.3);
  }

  /* Scrolled state - handled by JS */
  .header-scrolled .header-bg {
    background: rgba(254, 253, 251, 0.98);
    box-shadow: 0 4px 20px -4px rgba(30, 52, 72, 0.08);
  }

  /* Dropdown menu animation */
  .dropdown-menu {
    transform: translateY(-8px);
  }

  .group:hover .dropdown-menu {
    transform: translateY(0);
  }

  /* Mobile dropdown expanded state */
  .mobile-dropdown-expanded .mobile-dropdown-icon {
    transform: rotate(180deg);
  }

  .mobile-dropdown-expanded .mobile-dropdown-content {
    display: block;
  }
</style>

<script>
  const header = document.getElementById('main-header');
  const menuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = menuButton?.querySelector('.menu-icon');
  const closeIcon = menuButton?.querySelector('.close-icon');

  let isOpen = false;

  // Header scroll effect
  function handleScroll() {
    if (window.scrollY > 20) {
      header?.classList.add('header-scrolled');
    } else {
      header?.classList.remove('header-scrolled');
    }
  }

  window.addEventListener('scroll', handleScroll, { passive: true });
  handleScroll(); // Check initial state

  function toggleMenu() {
    isOpen = !isOpen;

    if (isOpen) {
      mobileMenu?.classList.remove('translate-x-full');
      mobileMenu?.classList.add('translate-x-0');
      menuIcon?.classList.add('hidden');
      closeIcon?.classList.remove('hidden');
      menuButton?.setAttribute('aria-expanded', 'true');
      mobileMenu?.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    } else {
      mobileMenu?.classList.add('translate-x-full');
      mobileMenu?.classList.remove('translate-x-0');
      menuIcon?.classList.remove('hidden');
      closeIcon?.classList.add('hidden');
      menuButton?.setAttribute('aria-expanded', 'false');
      mobileMenu?.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }
  }

  menuButton?.addEventListener('click', toggleMenu);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isOpen) {
      toggleMenu();
    }
  });

  // Mobile dropdown toggles
  const mobileDropdowns = document.querySelectorAll('.mobile-dropdown');
  mobileDropdowns.forEach((dropdown) => {
    const trigger = dropdown.querySelector('.mobile-dropdown-trigger');
    trigger?.addEventListener('click', () => {
      dropdown.classList.toggle('mobile-dropdown-expanded');
      const isExpanded = dropdown.classList.contains('mobile-dropdown-expanded');
      trigger.setAttribute('aria-expanded', isExpanded.toString());
    });
  });

  // Close mobile menu when clicking on links (except dropdown triggers)
  mobileMenu?.querySelectorAll('a').forEach((link) => {
    link.addEventListener('click', () => {
      if (isOpen) toggleMenu();
    });
  });
</script>
